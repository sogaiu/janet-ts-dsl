# EDN / JDN Tree-sitter Grammar DSL

Support for converting a tree-sitter grammar expressed in
[EDN](https://github.com/edn-format/edn) or
[JDN](https://github.com/andrewchambers/janet-jdn) to `grammar.json`
and `grammar.js`.  See the `data` directory for some examples.

## Background

The default DSL for expressing a grammar for tree-sitter is something
that is quite close to but not quite a standard JavaScript [1].

The TLDR is that I found working with JavaScript and existing
formatters for this particular endeavor to be unsatisfactory enough to
consider investigating alternatives.

Specifically, being able to work with EDN or JDN seems to reduce
enough some problems I experienced with `grammar.js`.

See [here](./doc/rationale.md) for detailed background.

## Status

It's possible to create `grammar.json` as well as `grammar.js`
starting from `grammar.edn` / `grammar.jdn`.

### `grammar.json`

The tooling here can do the left arrow portion of:

```
grammar.edn -> grammar.json -> parser.c
```

The right arrow portion can be accomplished by invoking `tree-sitter
generate grammar.json`.

The resulting `parser.c` is the same as if one used a typical
`tree-sitter generate` invocation that does:

```
grammar.js -> (grammar.json ->) parser.c
```

Note that using the former sequence starting with `grammar.edn` (or
`grammar.jdn`) does not use `node`, whereas the latter sequence that
starts with `grammar.js` does.

### `grammar.js`

It's possible to generate `grammar.js` from `grammar.edn` or
`grammar.jdn`.

This means that in theory one can test how well the generation works via
two paths:

1. `grammar.jdn` / `grammar.edn` -> `grammar.json`
2. `grammar.edn` / `grammar.jdn` -> `grammar.js`

After creating `grammar.json` via path 1 using the tooling here,
`grammar.js` can be generated via path 2 and then by using
`tree-sitter generate`, another `grammar.json` can be created and
compared with the one generated by path 1.

Another use of `grammar.js` generation might be if there is a desire
to stop using the tooling at some point.  To do this, it would be
nicer if comments were maintained and formatting was nicer in the
generated `grammar.js` :)

## Observations

Some miscellaneous observations:

* `grammar.edn` does not have to be written by hand.  One can write
  code (e.g. in Clojure) to generate `grammar.edn`.  Similarly for
  `grammar.jdn`.

* It's not necessary to express a grammar for Clojure using
  `grammar.edn`.  It should be possible to write grammars for other
  programming languages as well.  Similarly for Janet and
  `grammar.jdn`.

## Footnotes

[1] Some things that differ from "ordinary" JavaScript in
tree-sitter's flavor:

* Regular expression support differs in at least two sorts of ways:

  * Some standard constructs (e.g. assertions such as `^` and `$` are
    not supported).

  * Some non-standard constructs (e.g. character class binary
    operations) are supported.

  See
  [here](https://github.com/sogaiu/ts-questions/blob/943286abf49bdc621ee6466c2ca0dd75d2a76606/questions/what-regex-features-are-supported/README.md)
  for more details.

* Order of properties can matter within the main object typically
  representing the rules of the grammar:

  > 7. Rule Order - If none of the above criteria can be used to
  >    select one token over another, Tree-sitter will prefer the
  >    token that appears earlier in the grammar.

  via: https://tree-sitter.github.io/tree-sitter/creating-parsers#conflicting-tokens

  It's also the case if one's "start symbol" rule is not the first
  one, things may not work as expected.

  Technically speaking, older versions of JavaScript didn't guarantee
  an order, though in more recent versions things may be
  different...don't really want to know [the
  details](https://stackoverflow.com/a/30919039)...so what's the case
  for tree-sitter?

  With respect to JavaScript compatibility, there is [this
  claim](https://tree-sitter.github.io/tree-sitter/creating-parsers#dependencies):

  > Tree-sitter grammars are written in JavaScript, and Tree-sitter
  > uses Node.js to interpret JavaScript files. It requires the node
  > command to be in one of the directories in your PATH. Youâ€™ll need
  > Node.js version 6.0 or greater.

  I think it turns out in practice that one may need to try various
  different Node.js versions to get something that works.  For
  example, [in this
  case](https://github.com/tree-sitter/tree-sitter/issues/409), at the
  time, Node.js 12.x was "too recent".

---
